<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>都立数学 - 実戦模試</title>
    <script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root { --base: #fdf6e3; --text: #657b83; --accent: #d33682; --blue: #268bd2; --green: #859900; --red: #dc322f; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: var(--base); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        /* 問題表示エリア */
        #jxgbox { width: 100%; height: 320px; border-radius: 12px; margin: 20px 0; border: 1px solid #eee; }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--base); padding-bottom: 10px; }
        #q-badge { background: var(--blue); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        #question-text { font-size: 1.25rem; font-weight: 500; min-height: 60px; color: #333; }

        /* ボタンデザイン */
        .btn-group { display: flex; gap: 15px; margin-top: 25px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: transform 0.1s, opacity 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-correct { background-color: var(--green); color: white; box-shadow: 0 4px 0 #6c7a00; }
        .btn-wrong { background-color: var(--red); color: white; box-shadow: 0 4px 0 #b02422; }

        /* 結果画面 */
        .result-card { text-align: center; display: none; animation: fadeIn 0.5s ease; }
        .deviation-circle { width: 140px; height: 140px; line-height: 140px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #ff4d94); color: white; font-size: 3rem; margin: 25px auto; box-shadow: 0 6px 15px rgba(211, 54, 130, 0.3); font-weight: bold; }
        .analysis-box { background: #f9f9f9; padding: 20px; border-radius: 15px; text-align: left; margin: 20px 0; border-left: 5px solid var(--blue); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="test-ui">
        <div class="q-header">
            <span id="q-number" style="font-weight:bold; color:var(--text);">第 -- 問 / 13</span>
            <span id="q-badge">カテゴリ</span>
        </div>
        <div id="question-text">問題を読み込んでいます...</div>
        <div id="jxgbox" class="jxgbox"></div>
        <div class="btn-group">
            <button class="btn-wrong" onclick="processAnswer(false)">わからない・ミス</button>
            <button class="btn-correct" onclick="processAnswer(true)">正解できた！</button>
        </div>
    </div>

    <div id="result-ui" class="result-card">
        <h2 style="color: #333;">模試結果診断</h2>
        <div class="deviation-circle" id="res-dv">--</div>
        <p style="font-size: 1.2rem;">あなたの得点: <strong id="res-score" style="font-size: 1.8rem; color: var(--accent);">0</strong> / 100点</p>
        <div class="analysis-box">
            <strong style="color: var(--blue);">【AI弱点分析】</strong><br>
            <span id="res-weakness" style="font-size:0.95rem;"></span>
        </div>
        <button onclick="location.href='index.html'" style="background:#586e75; color:white; width:100%; margin-top:10px;">メニューに戻る</button>
    </div>
</div>

<script>
    // 【ここに practice.html の MasterDatabase = { ... }; を貼り付けてください】
    // 例: let MasterDatabase = { "d1_q1": [...], ... };

    let currentIdx = 0;
    let totalScore = 0;
    let testData = [];
    let wrongCategories = [];

    // 模試の構成（都立入試の配点・構成をシミュレート）
    function initTest() {
        const testConfig = [
            { id: 'd1_q1', name: '計算(基本)', w: 5 },
            { id: 'd1_q2', name: '平方根', w: 5 },
            { id: 'd1_q3', name: '一次方程式', w: 5 },
            { id: 'd1_q4', name: '連立方程式', w: 5 },
            { id: 'd1_q5', name: '二次方程式', w: 5 },
            { id: 'd1_q6', name: '関数(変化・変域)', w: 5 },
            { id: 'd1_q7', name: '平面図形(角度)', w: 5 },
            { id: 'd1_q8', name: '確率・統計', w: 6 },
            { id: 'd1_q9', name: '作図', w: 6 },
            { id: 'd2', name: '数と言葉(規則性)', w: 12 },
            { id: 'd3', name: '一次関数(グラフ応用)', w: 12 },
            { id: 'd4', name: '図形の性質(相似・三平方)', w: 12 },
            { id: 'd5', name: '空間図形', w: 12 }
        ];

        // 各カテゴリからランダムに1問選出
        testData = testConfig.map(config => {
            const questions = MasterDatabase[config.id];
            if (!questions) return null;
            const randomQ = questions[Math.floor(Math.random() * questions.length)];
            return { ...randomQ, ...config };
        }).filter(q => q !== null);

        if (testData.length === 0) {
            alert("問題データベースが見つかりません。MasterDatabaseを貼り付けてください。");
            return;
        }
        showQuestion();
    }

    function showQuestion() {
        const q = testData[currentIdx];
        document.getElementById('q-number').innerText = `第 ${currentIdx + 1} 問 / ${testData.length}`;
        document.getElementById('q-badge').innerText = q.name;
        document.getElementById('question-text').innerHTML = q.q;

        // 数式レンダリング（MathJax）
        if (window.MathJax) MathJax.typesetPromise();

        // 図形描画（JSXGraph）
        const box = document.getElementById('jxgbox');
        if (q.draw) {
            box.style.display = 'block';
            // ボードの初期化（以前の描画を消去）
            JXG.JSXGraph.freeBoard(board); 
            var board = JXG.JSXGraph.initBoard('jxgbox', {
                boundingbox: [-5, 5, 5, -5], 
                axis: true, 
                showCopyright: false,
                showNavigation: false
            });
            q.draw(board);
        } else {
            box.style.display = 'none';
        }
    }

    function processAnswer(isCorrect) {
        if (isCorrect) {
            totalScore += testData[currentIdx].w;
        } else {
            wrongCategories.push(testData[currentIdx].name);
        }

        if (currentIdx < testData.length - 1) {
            currentIdx++;
            showQuestion();
        } else {
            showFinalResult();
        }
    }

    function showFinalResult() {
        document.getElementById('test-ui').style.display = 'none';
        document.getElementById('result-ui').style.display = 'block';
        
        // 偏差値の簡易計算 (平均60、標準偏差15と仮定)
        const dv = Math.round(((totalScore - 60) / 15) * 10 + 50);
        document.getElementById('res-score').innerText = totalScore;
        document.getElementById('res-dv').innerText = Math.max(30, Math.min(75, dv));

        const weaknessText = wrongCategories.length > 0 
            ? "集中強化すべき分野: <br><span style='color:var(--red);'>" + [...new Set(wrongCategories)].join('、') + "</span>"
            : "素晴らしい！全問正解です。基礎から応用まで完璧に定着しています。";
        document.getElementById('res-weakness').innerHTML = weaknessText;
    }

    // 起動
    window.onload = function() {
        if (typeof MasterDatabase === 'undefined') {
            document.getElementById('question-text').innerText = "エラー: MasterDatabaseが定義されていません。コード内にデータを貼り付けてください。";
        } else {
            initTest();
        }
    };
</script>
</body>
</html>
