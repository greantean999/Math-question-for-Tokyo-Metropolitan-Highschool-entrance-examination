<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>都立数学特訓 - 大問5 空間図形</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 10px; background: #fdf6e3; }
        .back-link { text-decoration: none; color: #859900; font-weight: bold; margin-bottom: 15px; display: inline-block; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid #859900; }
        #prob-text { font-size: 1.1em; line-height: 1.6; margin: 10px 0; min-height: 60px; font-weight: bold; }
        .jxgbox { width: 100%; height: 400px; margin: 15px 0; border-radius: 10px; background: white; cursor: grab; }
        .jxgbox:active { cursor: grabbing; }
        .action-btn { width: 100%; padding: 15px; font-size: 18px; border-radius: 12px; border: none; background: #859900; color: white; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .ans-box { display: none; margin-top: 15px; padding: 15px; background: #f9fdf0; border-radius: 10px; border: 2px solid #859900; }
        .hint-badge { display: inline-block; background: #268bd2; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8em; margin-bottom: 5px; }
    </style>
</head>
<body>

<a href="index.html" class="back-link">← メニューに戻る</a>

<div class="card">
    <div class="hint-badge">図のまわりをドラッグして回転させてみよう！</div>
    <div id="prob-text">問題読み込み中...</div>
    <div id="jxgbox" class="jxgbox"></div>
    <button id="show-btn" class="action-btn" onclick="showAnswer()">答え合わせ</button>
    <button class="action-btn" style="background:#8E8E93;" onclick="loadProblem()">次の問題</button>
    
    <div id="ans-area" class="ans-box">
        <div id="ans" style="font-weight:bold; font-size:1.3em; color:#859900; border-bottom:1px solid #ccc; padding-bottom:5px;"></div>
        <div id="exp" style="font-size: 0.95em; color: #444; line-height: 1.7; margin-top: 10px;"></div>
    </div>
</div>

<script>
let board = null;

// 点を生成する際の共通設定（fixed:trueで固定）
const pOpts = {size: 1, name: '', fixed: true};

const pOpts = {size: 1, name: '', fixed: true};

const database = [
    {
        text: String.raw`1辺が $6\text{cm}$ の立方体があります。この立方体の体積を求めなさい。`,
        ans: String.raw`$216\text{cm}^3$`,
        exp: String.raw`立方体の体積は（1辺）$^3$ です。$6 \times 6 \times 6 = 216$。`,
        draw: (view) => {
            let p = [[0,0,0],[3,0,0],[3,3,0],[0,3,0],[0,0,3],[3,0,3],[3,3,3],[0,3,3]].map(c => view.create('point3d', c, pOpts));
            [[0,1,2,3],[4,5,6,7],[0,1,5,4],[2,3,7,6],[1,2,6,5],[0,3,7,4]].forEach(f => 
                view.create('polygon3d', f.map(i=>p[i]), {fillColor:'#859900', fillOpacity:0.2, borderLine:{strokeWidth:1}})
            );
        }
    },
    {
        text: String.raw`底面が1辺 $4\text{cm}$ の正方形で、高さが $6\text{cm}$ の正四角錐の体積を求めなさい。`,
        ans: String.raw`$32\text{cm}^3$`,
        exp: String.raw`錐体の体積は「底面積 $\times$ 高さ $\div 3$」です。$(4 \times 4) \times 6 \div 3 = 32$。`,
        draw: (view) => {
            let pts = [[-2,-2,0],[2,-2,0],[2,2,0],[-2,2,0]].map(c => view.create('point3d', c, pOpts));
            let top = view.create('point3d', [0,0,4], {name:'V', fixed:true});
            view.create('polygon3d', pts, {fillColor:'#268bd2', fillOpacity:0.1});
            pts.forEach((pt, i) => view.create('polygon3d', [pt, pts[(i+1)%4], top], {fillColor:'#268bd2', fillOpacity:0.3}));
        }
    },
    {
        text: String.raw`立方体の辺ABと「ねじれの位置」にある辺は全部でいくつありますか。`,
        ans: String.raw`$4$ つ`,
        exp: String.raw`同じ平面上になく、平行でも交わりもしない辺を探します。`,
        draw: (view) => {
            let p = [[0,0,0],[3,0,0],[3,3,0],[0,3,0],[0,0,3],[3,0,3],[3,3,3],[0,3,3]].map(c => view.create('point3d', c, pOpts));
            view.create('segment3d', [p[0], p[1]], {strokeColor:'red', strokeWidth:5}); 
            [[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]].forEach(e => view.create('segment3d', [p[e[0]], p[e[1]]]));
        }
    },
    {
        text: String.raw`半径 $3\text{cm}$ の球の表面積を求めなさい。`,
        ans: String.raw`$36\pi \text{cm}^2$`,
        exp: String.raw`球の表面積の公式は $4\pi r^2$ です。$4 \times \pi \times 3^2 = 36\pi$。`,
        draw: (view) => {
            // 3方向の輪っかを描画して球を表現
            view.create('ellipse3d', [[0,0,0], [3,0,0], [0,3,0]], {strokeColor:'#ccc'});
            view.create('ellipse3d', [[0,0,0], [3,0,0], [0,0,3]], {strokeColor:'#ccc'});
            view.create('ellipse3d', [[0,0,0], [0,3,0], [0,0,3]], {strokeColor:'#ccc'});
            view.create('point3d', [0,0,0], {name:'O', size:2, fixed:true});
        }
    },
    {
        text: String.raw`底面の半径が $3\text{cm}$、高さが $4\text{cm}$ の円錐の母線の長さを求めなさい。`,
        ans: String.raw`$5\text{cm}$`,
        exp: String.raw`三平方の定理より $\sqrt{3^2 + 4^2} = 5$。`,
        draw: (view) => {
            view.create('ellipse3d', [[0,0,0], [3,0,0], [0,3,0]], {fillOpacity:0.1});
            let top = view.create('point3d', [0,0,4], {name:'V', fixed:true});
            let p1 = view.create('point3d', [3,0,0], pOpts);
            let p2 = view.create('point3d', [-3,0,0], pOpts);
            view.create('segment3d', [[0,0,0], p1], {dash:2});
            view.create('segment3d', [[0,0,0], top], {dash:2});
            view.create('segment3d', [p1, top], {strokeColor:'red', strokeWidth:3});
            view.create('segment3d', [p2, top], {strokeColor:'#333'});
        }
    },
    {
        text: String.raw`底面の半径が $2\text{cm}$、高さが $5\text{cm}$ の円柱の体積を求めなさい。`,
        ans: String.raw`$20\pi \text{cm}^3$`,
        exp: String.raw`底面積 $\times$ 高さ です。$(\pi \times 2^2) \times 5 = 20\pi$。`,
        draw: (view) => {
            view.create('ellipse3d', [[0,0,-2], [2,0,-2], [0,2,-2]], {fillOpacity:0.1});
            view.create('ellipse3d', [[0,0,2], [2,0,2], [0,2,2]], {fillOpacity:0.1});
            view.create('segment3d', [[2,0,-2], [2,0,2]]);
            view.create('segment3d', [[-2,0,-2], [-2,0,2]]);
        }
    },
    {
        text: String.raw`1辺 $6\text{cm}$ の正四面体のすべての辺の長さの和を求めなさい。`,
        ans: String.raw`$36\text{cm}$`,
        exp: String.raw`正四面体の辺の数は 6 本です。$6 \times 6 = 36$。`,
        draw: (view) => {
            // 座標を調整して綺麗な正四面体に
            let pts = [[2,0,-1.4], [-2,0,-1.4], [0,1.7,1.4], [0,-1.7,1.4]].map(c => view.create('point3d', c, pOpts));
            [[0,1],[0,2],[0,3],[1,2],[1,3],[2,3]].forEach(e => view.create('segment3d', [pts[e[0]], pts[e[1]]]));
        }
    },
    {
        text: String.raw`縦 $3\text{cm}$, 横 $4\text{cm}$, 高さ $5\text{cm}$ の直方体の対角線の長さを求めなさい。`,
        ans: String.raw`$5\sqrt{2}\text{cm}$`,
        exp: String.raw`対角線は $\sqrt{3^2 + 4^2 + 5^2} = 5\sqrt{2}$ です。`,
        draw: (view) => {
            let p = [[0,0,0],[2,0,0],[2,3,0],[0,3,0],[0,0,4],[2,0,4],[2,3,4],[0,3,4]].map(c => view.create('point3d', c, pOpts));
            view.create('segment3d', [p[0], p[6]], {strokeColor:'red', strokeWidth:3});
            [[0,1,2,3,0],[4,5,6,7,4],[0,4],[1,5],[2,6],[3,7]].forEach(f => {
                for(let i=0; i<f.length-1; i++) view.create('segment3d', [p[f[i]], p[f[i+1]]]);
            });
        }
    },
    {
        text: String.raw`半径 $3\text{cm}$ の球を、中心を通る平面で切ったときの切り口の面積を求めなさい。`,
        ans: String.raw`$9\pi \text{cm}^2$`,
        exp: String.raw`切り口は半径 $3\text{cm}$ の円になります。$\pi \times 3^2 = 9\pi$。`,
        draw: (view) => {
            view.create('ellipse3d', [[0,0,0], [3,0,0], [0,3,0]], {fillColor:'yellow', fillOpacity:0.4});
            view.create('ellipse3d', [[0,0,0], [3,0,0], [0,0,3]], {strokeWidth:1});
            view.create('ellipse3d', [[0,0,0], [0,3,0], [0,0,3]], {strokeWidth:1});
        }
    },
    {
        text: String.raw`三角柱の側面は全部でいくつありますか。`,
        ans: String.raw`$3$ つ`,
        exp: String.raw`側面は長方形で、底面の辺の数と同じだけ存在します。`,
        draw: (view) => {
            let p = [[0,0,0],[2.5,0,0],[0,2,0],[0,0,4],[2.5,0,4],[0,2,4]].map(c => view.create('point3d', c, pOpts));
            view.create('polygon3d', [p[0],p[1],p[2]], {fillColor:'blue', fillOpacity:0.1});
            view.create('polygon3d', [p[3],p[4],p[5]], {fillColor:'blue', fillOpacity:0.1});
            [[0,3],[1,4],[2,5]].forEach(e => view.create('segment3d', [p[e[0]], p[e[1]]]));
            view.create('segment3d', [p[0], p[1]]); view.create('segment3d', [p[1], p[2]]); view.create('segment3d', [p[2], p[0]]);
            view.create('segment3d', [p[3], p[4]]); view.create('segment3d', [p[4], p[5]]); view.create('segment3d', [p[5], p[3]]);
        }
    }
];

function loadProblem() {
    const q = database[Math.floor(Math.random() * database.length)];
    document.getElementById('prob-text').innerHTML = q.text;
    document.getElementById('ans').innerHTML = "正解：" + q.ans;
    document.getElementById('exp').innerHTML = "【解説】<br>" + q.exp;
    document.getElementById('ans-area').style.display = 'none';
    
    if(board) JXG.JSXGraph.freeBoard(board);
    
    board = JXG.JSXGraph.initBoard('jxgbox', {
        boundingbox: [-5, 5, 5, -5], 
        keepaspectratio: false, 
        axis: false, 
        showCopyright: false,
        pan: { enabled: false } 
    });

    // azimuth/elevationを明示的に指定して再描画を安定させる
    let view = board.create('view3d', 
        [[-3, -1], [6, 6], [[-4, 4], [-4, 4], [-4, 4]]], 
        {
            azimuth: 0.8,
            elevation: 0.5,
            xPlaneOpts: {visible: false},
            yPlaneOpts: {visible: false}
        }
    );
    
    q.draw(view);
    
    // 重要：すべてのオブジェクトが生成された後に全ボードを強制アップデート
    board.fullUpdate(); 
    if(window.MathJax) MathJax.typesetPromise();
}

function showAnswer() {
    document.getElementById('ans-area').style.display = 'block';
}

window.onload = loadProblem;
</script>
</body>
</html>
