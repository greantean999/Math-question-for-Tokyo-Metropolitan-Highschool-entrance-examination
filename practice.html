<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学演習システム</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css">
    
    <script src="auth.js"></script>
    <script src="problems_db.js"></script>

    <style>
        body { font-family: sans-serif; background: #fdf6e3; padding: 20px; line-height: 1.6; }
        #app-container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #question-text { font-size: 1.2rem; margin-bottom: 20px; min-height: 50px; }
        #jxgbox { width: 100%; height: 300px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { 
            width: 100%; padding: 12px; font-size: 1rem; cursor: pointer; border: none; 
            border-radius: 8px; background: #268bd2; color: white; margin-bottom: 10px;
        }
        button:active { background: #2176b3; }
        .nav-btn { background: #93a1a1; }
        #answer-area { background: #eee8d5; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .label { font-weight: bold; color: #b58900; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="question-text">読み込み中……</div>
    
    <div id="jxgbox" style="display:none;"></div>

    <button id="show-ans-btn" onclick="showAnswer()">答え合わせを表示</button>

    <div id="answer-area" style="display:none;">
        <p><span class="label">【正解】</span> <span id="answer-text"></span></p>
        <p><span class="label">【解説】</span> <span id="explanation-text"></span></p>
        <button onclick="location.reload()">次の問題へ</button>
    </div>

    <button class="nav-btn" onclick="location.href='index.html'">トップに戻る</button>
</div>

<script>
    let board = null;

    window.onload = function() {
        if (typeof MasterDatabase === 'undefined') {
            document.getElementById('question-text').innerHTML = "<b style='color:red;'>エラー: problems_db.jsが読み込めません。</b>";
            return;
        }
        loadQuestion();
    };

    function loadQuestion() {
        const params = new URLSearchParams(window.location.search);
        const catId = params.get('cat') || 'd1_q1';
        const problems = MasterDatabase[catId];

        if (!problems) {
            document.getElementById('question-text').innerText = "カテゴリがありません。";
            return;
        }

        const currentProblem = problems[Math.floor(Math.random() * problems.length)];
        
        // テキスト反映
        document.getElementById('question-text').innerHTML = currentProblem.q;
        document.getElementById('answer-text').innerHTML = currentProblem.a;
        document.getElementById('explanation-text').innerHTML = currentProblem.e || "解説はありません。";

        // 数式処理
        if (window.MathJax) MathJax.typeset();

        // 図形処理
        const box = document.getElementById('jxgbox');
        if (currentProblem.draw) {
            box.style.display = 'block';
            if (board) JXG.JSXGraph.freeBoard(board);
            board = JXG.JSXGraph.initBoard('jxgbox', {boundingbox: [-5, 5, 5, -5], axis: true, showCopyright: false});
            currentProblem.draw(board);
        } else {
            box.style.display = 'none';
        }
    }

    function showAnswer() {
        document.getElementById('answer-area').style.display = 'block';
        document.getElementById('show-ans-btn').style.display = 'none';
    }
</script>

</body>
</html>
