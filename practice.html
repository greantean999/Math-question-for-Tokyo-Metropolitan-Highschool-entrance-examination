<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学演習システム</title>

    <script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css">
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            chtml: { displayAlign: 'left' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="auth.js"></script>
    <script src="problems_db.js"></script>

    <style>
        /* 読み込み中の表示を整える（任意） */
        #problem-container.loading {
            opacity: 0.5;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="question-text">読み込み中……</div>
    
    <div id="jxgbox" style="display:none;"></div>

    <button id="show-ans-btn" onclick="showAnswer()">答え合わせを表示</button>

    <div id="answer-area" style="display:none;">
        <p><span class="label">【正解】</span> <span id="answer-text"></span></p>
        <p><span class="label">【解説】</span> <span id="explanation-text"></span></p>
        <button onclick="location.reload()">次の問題へ</button>
    </div>

    <button class="nav-btn" onclick="location.href='index.html'">トップに戻る</button>
</div>

<script>
    let board = null;

    window.onload = function() {
        if (typeof MasterDatabase === 'undefined') {
            document.getElementById('question-text').innerHTML = "<b style='color:red;'>エラー: problems_db.jsが読み込めません。</b>";
            return;
        }
        loadQuestion();
    };

    function loadQuestion() {
        const params = new URLSearchParams(window.location.search);
        const catId = params.get('cat') || 'd1_q1';
        const problems = MasterDatabase[catId];

        if (!problems) {
            document.getElementById('question-text').innerText = "カテゴリがありません。";
            return;
        }

        const currentProblem = problems[Math.floor(Math.random() * problems.length)];
        
        // テキスト反映
        document.getElementById('question-text').innerHTML = currentProblem.q;
        document.getElementById('answer-text').innerHTML = currentProblem.a;
        document.getElementById('explanation-text').innerHTML = currentProblem.e || "解説はありません。";

        // 数式処理
        if (window.MathJax) MathJax.typeset();

        // 図形処理
        const box = document.getElementById('jxgbox');
        if (currentProblem.draw) {
            box.style.display = 'block';
            if (board) JXG.JSXGraph.freeBoard(board);
            board = JXG.JSXGraph.initBoard('jxgbox', {boundingbox: [-5, 5, 5, -5], axis: true, showCopyright: false});
            currentProblem.draw(board);
        } else {
            box.style.display = 'none';
        }
    }

    function showAnswer() {
        document.getElementById('answer-area').style.display = 'block';
        document.getElementById('show-ans-btn').style.display = 'none';
    }
</script>

</body>
</html>
